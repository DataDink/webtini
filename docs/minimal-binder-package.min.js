((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MinimalBinder=t()})(this,function(){class Route{get root(){return this.#root}#root;get parent(){return this.#parent}#parent;get name(){return this.#name}#name;get value(){return this.#value}#value;get next(){return this.#next}#next;get last(){return this.#root.#last}#last;get path(){return[...this].slice(1).map(e=>e.name)}get data(){return this.last.parent?.value}get index(){return this.last.name}get result(){return this.last.value}constructor(e=null){(this.#root=this.#last=this).#value=e}*[Symbol.iterator](){for(var e=this.#root;e;e=e.#next)yield e}append(e,t){var n=this.#next=new Route;return n.#name=e,n.#value=t,n.#root=this.#root,(n.#parent=this).#root.#last=n}clone(){for(var e=new Route(this.#root.#value),t=this.#root.#next;t;t=t.#next)e=e.append(t.#name,t.#value);return e}static find(e,t){if(!(null==e||t in e)){var n,r=t.toLowerCase();for(n in e)if(n.toLowerCase()===r)return n}return t}select(e){return Route.select(this,e)}static select(e,t){return(Array.isArray(t)?t:[]).reduce((e,t)=>(t?.length&&"."!==t&&("~"===t?((e=e.#root).#last=e).#next=null:"^"===t?((e=e.#parent??e).#root.#last=e).#next=null:(t=Route.find(e.#value,t),e=e.append(t,e.#value?.[t]))),e),e instanceof Route?e.clone():new Route(e))}assign(e){return Route.assign(this,e)}static assign(e,t){if(!(e instanceof Route))throw new Error("Route.assign: route must be an instance of a Route.");var n=new Route(e.#root.#value);if(null!=e.root.next&&null!=n.value){for(var r=e.root.next;r;r=r.next)var i=Route.find(n.value,r.name),n=n.append(i,n.value[i]??={});n.#value=n.data[n.name]=t}return n}}class Binder{static get ATTRIBUTE(){return"bind"}static get PREFIX(){return"bind-"}#active=0;get active(){return 0<this.#active}#extensions=[];constructor(...e){this.#extensions=e??[]}bind(t,n){if(this.#active++,n=n instanceof Route?n:new Route(n),!this.#extensions.find(e=>e.handleElement(this,t,n))&&t instanceof Element){for(var r of[...t.attributes]){var e,i=r.name.toLowerCase();r.name.startsWith(Binder.PREFIX)&&(i=i.substring(Binder.PREFIX.length),this.#extensions.find(e=>e.handleAttribute(this,t,n,i,r.value))||(e=n.select(r.value?.split(".")).value,Route.select(t,i.split("-")).assign(e)))}var a,s=t.hasAttribute(Binder.ATTRIBUTE)?n.select(t.getAttribute(Binder.ATTRIBUTE)?.split(".")):n;for(a of[...t.childNodes])this.bind(a,s)}return this.#active--,t}static Extension=class Extension{handleElement(e,t,n){return!1}handleAttribute(e,t,n,r,i){return!1}}}class TemplateBinder extends Binder.Extension{static get RECURSE(){return"recurse"}static#instances=Symbol("template-instances");static#instance=Symbol("template-instance");handleElement(e,t,n){if(!t[TemplateBinder.#instance]){if(!(t instanceof HTMLTemplateElement))return!1;n=t.hasAttribute(Binder.ATTRIBUTE)?n.select(t.getAttribute(Binder.ATTRIBUTE)?.split(".")):n;for(var r=t.hasAttribute(Binder.ATTRIBUTE)&&t.hasAttribute(TemplateBinder.RECURSE),i=null==n.result?[]:Array.isArray(n.result)?n.result.map((e,t)=>n.clone().append(t.toString(),e)):[n],a=t[TemplateBinder.#instances]??=[];a.length>i.length;)for(d of l=a.pop())d[TemplateBinder.#instance]=!1,d instanceof HTMLTemplateElement&&e.bind(d,null),d.remove();for(var s=a.at(-1)?.at(-1)?.nextSibling??t.nextSibling;a.length<i.length;){var o,l=[...t.content.cloneNode(!0).childNodes];a.push(l);for(d of l)d[TemplateBinder.#instance]=!0,t.parentNode.insertBefore(d,s);r&&(o=t.cloneNode(!0),l.push(o),t.parentNode.insertBefore(o,s))}for(var u=0;u<i.length;u++)for(var d of a[u])d[TemplateBinder.#instance]=!1,e.bind(d,i[u]),d[TemplateBinder.#instance]=!0}return!0}}class EventBinder extends Binder.Extension{static get PREFIX(){return"event-"}static#events=Symbol("events");handleAttribute(t,n,r,i,e){if(!i.startsWith(EventBinder.PREFIX))return!1;var i=i.substring(EventBinder.PREFIX.length),a=n[EventBinder.#events]??={},r=r.select(e.split("."));if(!(i in a&&a[i].data===r.data&&a[i].handler===a[i].result)&&(i in a&&(n.removeEventListener(i,a[i].binding),delete a[i]),"function"==typeof r.result)){let e=a[i]={data:r.data,handler:r.result,binding:function(){if(!t.active)return e.handler.apply(e.data,arguments)}};n.addEventListener(i,a[i].binding)}return!0}}class MinimalBinder extends Binder{constructor(...e){super(...e,new TemplateBinder,new EventBinder)}static Extension=Binder.Extension}return MinimalBinder});